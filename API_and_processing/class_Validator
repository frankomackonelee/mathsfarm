<?php
	/**
	 * 
	 */
	class Pos_Validator {
		protected $_inputType;
		protected $_submitted;
		protected $_required;
		protected $_filterArgs;
		protected $_filtered;
		protected $_missing;
		protected $_errors;
		protected $_booleans;
		
		public function __construct($required=array(), $inputType='POST') {
			if (!function_exists('filter_list')) {
				throw new Exception("The Pos_Validator class requires the Filter Functions in >= PHP5.2 or PECL");
			}
			if (!is_null($required) && !is_array($required)) {
				throw new Exception("The names of required fields must be an array even if only one field is required");
			}
			
			$this->_required = $required;
			$this->setInputType($inputType);
			if ($this->_required) {
				$this->checkRequired();
			}
			$this->_filterArgs = array();
			$this->_errors = array();
			$this->_booleans = array();
		}
				
		public function isInt($fieldName, $min = null, $max = null)
		{
			$this->checkDuplicateFilter($fieldName);
			$this->_filterArgs[$fieldName] = array('filter' => FILTER_VALIDATE_INT);
			if(is_int($min)){
				$this->_filterArgs[$fieldName]['options']['min_range'] = $min;
			}
			if(is_int($max)){
				$this->_filterArgs[$fieldName]['options']['max_range'] = $max;
			}
		}
		
		public function isFloat($fieldName, $decimalPoint = '.', $allowThousandSeparator = true)
		{
			$this->checkDuplicateFilter($fieldName);
			if($decimalPoint!= '.' && $decimalPoint!= ','){
				throw new Exception("Decimal point must be a comma or a period in isFloat()");
			}
			$this->_filterArgs[$fieldName] = array(
				'filter' => FILTER_VALIDATE_FLOAT,
				'options' => array('decimal' => $decimalPoint)
			);
			if($allowThousandSeparator){
				$this->_filterArgs[$fieldName]['flags'] = FILTER_FLAG_ALLOW_THOUSAND;
			}
		}
		
		public function isNumericArray($fieldName, $allowDecimalFractions = true, $decimalPoint = '.', $allowThousandSeparator = true)
		{
			$this->checkDuplicateFilter($fieldName);
			if($decimalPoint!= '.' && $decimalPoint!= ','){
				throw new Exception("Decimal point must be a comma or a period in isFloat()");
			}
			$this->_filterArgs[$fieldName] = array(
				'filter' => FILTER_VALIDATE_FLOAT,
				'flags' => FILTER_REQUIRE_ARRAY,
				'options' => array('decimal' => $decimalPoint)
			);
			if($allowDecimalFractions){
				$this->_filterArgs[$fieldName]['flags'] |= FILTER_FLAG_ALLOW_FRACTION;
			}
			if($allowThousandSeparator){
				$this->_filterArgs[$fieldName]['flags'] |= FILTER_FLAG_ALLOW_THOUSAND;
			}
		}
		
		public function isEmail($fieldName)
		{
			$this->checkDuplicateFilter($fieldName);
			$this->_filterArgs[$fieldName] = FILTER_VALIDATE_EMAIL;
		}

		public function isFullURL($fieldName, $queryStringRequired = false)
		{
			$this->checkDuplicateFilter($fieldName);
			$this->_filterArgs[$fieldName] = array(
				'filter' => FILTER_VALIDATE_URL,
				'flags' => FILTER_FLAG_SCHEME_REQUIRED | FILTER_FLAG_HOST_REQUIRED | FILTER_FLAG_PATH_REQUIRED
			);
			if ($queryStringRequired) {
				$this->_filterArgs[$fieldName]['flags'] |= FILTER_FLAG_QUERY_REQUIRED;
			}
		}
		
		public function isURL($fieldName, $queryStringRequired = false)
		{
			$this->checkDuplicateFilter($fieldName);
			$this->_filterArgs[$fieldName]['filter'] =  FILTER_VALIDATE_URL;
			if ($queryStringRequired) {
				$this->_filterArgs[$fieldName]['flags'] = FILTER_FLAG_QUERY_REQUIRED;
			}
		}
		
		public function isBool($fieldName, $nullOnFailure = false)
		{
			$this->checkDuplicateFilter($fieldName);
			$this->_booleans[] = $fieldName;
			$this->_filterArgs[$fieldName]['filter'] = FILTER_VALIDATE_BOOLEAN;
			if($nullOnFailure){
				$this->_filterArgs[$fieldName]['flags'] = FILTER_NULL_ON_FAILURE;
			}
		}
		
		public function matches($fieldName, $pattern)
		{
			$this->checkDuplicateFilter($fieldName);
			$this->_filterArgs[$fieldName] = array(
				'filter' => FILTER_VALIDATE_REGEXP,
				'options' => array('regexp' => $pattern)
			);
		}
		
		public function removeTags($fieldName, $encodeAmb = false, $preserveQuotes = false, 
					$encodeLow = false, $encodeHigh = false, $stripLow = false, $stripHigh = false)
		{
			$this->checkDuplicateFilter($fieldName);
			$this->_filterArgs[$fieldName]['filter'] = FILTER_SANITIZE_STRING;
			$this->_filterArgs[$fieldName]['flags'] = 0;
			$inputToConstantMap = array(	$encodeAmb => FILTER_FLAG_ENCODE_AMP, 
											$preserveQuotes => FILTER_FLAG_NO_ENCODE_QUOTES, 
											$encodeLow => FILTER_FLAG_ENCODE_LOW, 
											$encodeHigh => FILTER_FLAG_ENCODE_HIGH, 
											$stripLow => FILTER_FLAG_STRIP_LOW, 
											$stripHigh => FILTER_FLAG_STRIP_HIGH	);
											
			foreach ($inputToConstantMap as $input => $constant) {
				if ($input) {
					$this->_filterArgs[$fieldName]['flags'] |= $constant;	
				}
			}
		}
		
		public function removeTagsFromArray($fieldName, $encodeAmb = false, $preserveQuotes = false, 
					$encodeLow = false, $encodeHigh = false, $stripLow = false, $stripHigh = false)
		{
			$this->checkDuplicateFilter($fieldName);
			$this->_filterArgs[$fieldName]['filter'] = FILTER_SANITIZE_STRING;
			$this->_filterArgs[$fieldName]['flags'] = FILTER_REQUIRE_ARRAY;
			$inputToConstantMap = array(	$encodeAmb => FILTER_FLAG_ENCODE_AMP, 
											$preserveQuotes => FILTER_FLAG_NO_ENCODE_QUOTES, 
											$encodeLow => FILTER_FLAG_ENCODE_LOW, 
											$encodeHigh => FILTER_FLAG_ENCODE_HIGH, 
											$stripLow => FILTER_FLAG_STRIP_LOW, 
											$stripHigh => FILTER_FLAG_STRIP_HIGH	);
											
			foreach ($inputToConstantMap as $input => $constant) {
				if ($input) {
					$this->_filterArgs[$fieldName]['flags'] |= $constant;	
				}
			}
		}
		
		public function useEntities($fieldName, $isArray = false, $encodeHigh = false, $stripLow = false, $stripHigh = false)
		{
			$this->checkDuplicateFilter($fieldName);
			$this->_filterArgs[$fieldName]['filter'] = FILTER_SANITIZE_SPECIAL_CHARS;
			$this->_filterArgs[$fieldName]['flags'] = 0;
			$inputToConstantMap = array(	$isArray => FILTER_REQUIRE_ARRAY, 
											$encodeHigh => FILTER_FLAG_ENCODE_HIGH, 
											$stripLow => FILTER_FLAG_STRIP_LOW, 
											$stripHigh => FILTER_FLAG_STRIP_HIGH	);
											
			foreach ($inputToConstantMap as $input => $constant) {
				if ($input) {
					$this->_filterArgs[$fieldName]['flags'] |= $constant;	
				}
			}
		}
		
		public function checkTextLength($fieldName, $min, $max = null)
		{
			$text = trim($this->_submitted[$fieldName]);
			if (!is_string($text)) {
				throw new Exception("The checkTextLength() function can only be applied to strings; $fieldName is the wrong datatype");
			}
			if (!is_numeric($min)){
				throw new Exception("The checkTextLength() function takes a number as it's second argument (field name: $fieldName)");
			}
			if (strlen($text)<$min) {
				if (is_numeric($max)) {
					$this->_errors[$fieldName][] = ucfirst($fieldName) . " must be between $min and $max characters long";	
				}else{
					$this->_errors[$fieldName][] = ucfirst($fieldName) . " must be longer than $min characters long";	
				}		
			}
			if (is_numeric($max) && strlen($text)>$max){
				if($min == 0){
					$this->_errors[$fieldName][] = ucfirst($fieldName) . " must be no more than $max characters long";					
				}else{
					$this->_errors[$fieldName][] = ucfirst($fieldName) . " must be between $min and $max characters long";	
				}
			}
		}
		
		public function noFilter($fieldName, $isArray = false, $encodeAmp = false)
		{
			$this->checkDuplicateFilter($fieldName);
			$this->_filterArgs[$fieldName]['filter'] = FILTER_UNSAFE_RAW;
			$this->_filterArgs[$fieldName]['flags'] = 0;
			if ($isArray) {
				$this->_filterArgs[$fieldName]['flags'] |= FILTER_REQUIRE_ARRAY;
			}
			if ($encodeAmp){
				$this->_filterArgs[$fieldName]['flags'] |= FILTER_FLAG_ENCODE_AMP;
			}
		}
		
		public function validateInput()
		{
			//array for required, unfiltered items - this could be changed so that it looks at all submitted items...
			//all should be filtered surely, required or not?
			$notFiltered = array();
			$tested = array_keys($this->_filterArgs);
			foreach ($this->_required as $field) {
				if (!in_array($field, $tested)) {
					$notFiltered[] = $field;
				}
			}
			if ($notFiltered) {
				throw new Exception('No filter has been set for the following required item(s): ' . implode(',', $notFiltered));
			}
			
			//The business of filtering gets done:
			//TODO: should it not be _submitted?!
			$this->_filtered = filter_input_array($this->_inputType, $this->_filterArgs);
			
			//Find which items failed validation:
			foreach ($this->_filtered as $key => $value) {
				//passes over booleans, missing values or ones not required
				//TODO: not sure that this is the logic we want!
			if(in_array($key, $this->_booleans) || in_array($key, $this->_missing) || !in_array($key, $this->_required)){
					continue;
				}elseif ($value=== false){
					if (isset($this->_errors[$key]) && is_array($this->_errors[$key])) {
						$this->_errors[$key][] = ucfirst($key) . ': invalid data supplied';	
					}else{
						$this->_errors[$key] = ucfirst($key) . ': invalid data supplied';
					}
				};	
			}		
			
			//returns an array containing the validated input
			return $this->_filtered;
		}

		public function getMissing()
		{
			return $this->_missing;
		}
		
		public function getFiltered()
		{
			return $this->_filtered;
		}
		
		public function getErrors()
		{
			return $this->_errors;
		}
		
		protected function setInputType($type)
		{
			switch (strtolower($type)) {
				case 'post':
					$this->_inputType = INPUT_POST;
					$this->_submitted = $_POST;
					break;

				case 'get':
					$this->_inputType = INPUT_GET;
					$this->_submitted = $_GET;
					break;
										
				default:
					throw new Exception('Invalid input type. Valid types are  "post" and "get". "' . $type .' was passed');
					break;
			}
		}
		
		protected function checkRequired()
		{
			$OK = array();
			foreach ($this->_submitted as $name => $value) {
				$value = is_array($value) ? $value : trim($value);
				if (!empty($value)) {
					$OK[] = $name;
				}
			}
			$this->_missing = array_diff($this->_required, $OK);
		}
		
		protected function checkDuplicateFilter($fieldName)
		{
			if(isset($this->_filterArgs[$fieldName])){
				throw new Exception('A filter has already been set for the field name "' . $fieldName . '"');
			}
		}
		
		//This can be used while in test
		public function forTestDeleteMe($dumpVariables)
		{
			foreach ($dumpVariables as $value) {
				print "<hr>Contents of " . $value . " object:";
				print "<pre>";
				print_r($this->$value);
				print "</pre>";	
			}
		}
	}
	

?>
